
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>brainpy.brainpy &#8212; brainpy  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for brainpy.brainpy</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">float_info</span>

<span class="kn">from</span> <span class="nn">brainpy.mass_dict</span> <span class="k">import</span> <span class="n">nist_mass</span>
<span class="kn">from</span> <span class="nn">brainpy.composition</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">PyComposition</span><span class="p">,</span>
    <span class="n">parse_formula</span><span class="p">,</span>
    <span class="n">calculate_mass</span><span class="p">,</span>
    <span class="n">_make_isotope_string</span><span class="p">,</span>
    <span class="n">_get_isotope</span><span class="p">)</span>

<span class="n">mz_getter</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;mz&quot;</span><span class="p">)</span>
<span class="n">PROTON</span> <span class="o">=</span> <span class="n">nist_mass</span><span class="p">[</span><span class="s2">&quot;H+&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">MACHINE_EPSILON</span> <span class="o">=</span> <span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span>
<span class="n">ZERO</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">ONE</span> <span class="o">=</span> <span class="mf">1.0</span>


<span class="k">def</span> <span class="nf">neutral_mass</span><span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">charge_carrier</span><span class="o">=</span><span class="n">PROTON</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mz</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">charge_carrier</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mass_charge_ratio</span><span class="p">(</span><span class="n">neutral_mass</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">charge_carrier</span><span class="o">=</span><span class="n">PROTON</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">neutral_mass</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">charge_carrier</span><span class="p">))</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">give_repr</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Patch a class to give it a generic __repr__ method</span>
<span class="sd">    that works by inspecting the instance dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cls: type</span>
<span class="sd">        The class to add a generic __repr__ to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cls: type</span>
<span class="sd">        The passed class is returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">reprer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attribs</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)])</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{self.__class__.__name__}</span><span class="s2">(</span><span class="si">{attribs}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribs</span><span class="o">=</span><span class="n">attribs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrap</span>
    <span class="bp">cls</span><span class="o">.</span><span class="fm">__repr__</span> <span class="o">=</span> <span class="n">reprer</span>
    <span class="k">return</span> <span class="bp">cls</span>


<span class="nd">@give_repr</span>
<span class="k">class</span> <span class="nc">PolynomialParameters</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elementary_symmetric_polynomial</span><span class="p">,</span> <span class="n">power_sum</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elementary_symmetric_polynomial</span> <span class="o">=</span> <span class="n">elementary_symmetric_polynomial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_sum</span> <span class="o">=</span> <span class="n">power_sum</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_sum</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementary_symmetric_polynomial</span>


<span class="nd">@give_repr</span>
<span class="k">class</span> <span class="nc">PhiConstants</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">element_coefficients</span><span class="p">,</span> <span class="n">mass_coefficients</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element_coefficients</span> <span class="o">=</span> <span class="n">element_coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_coefficients</span> <span class="o">=</span> <span class="n">mass_coefficients</span>


<span class="k">def</span> <span class="nf">newton</span><span class="p">(</span><span class="n">power_sum</span><span class="p">,</span> <span class="n">elementary_symmetric_polynomial</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given two lists of values, the first list being the `power sum`s of a</span>
<span class="sd">    polynomial, and the second being expressions of the roots of the</span>
<span class="sd">    polynomial as found by Viete&#39;s Formula, use information from the longer list to</span>
<span class="sd">    fill out the shorter list using Newton&#39;s Identities.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Updates are done **in place**</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    power_sum: list of float</span>
<span class="sd">    elementary_symmetric_polynomial: list of float</span>
<span class="sd">    order: int</span>
<span class="sd">        The number of terms to expand to when updating `elementary_symmetric_polynomial`</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    https://en.wikipedia.org/wiki/Newton%27s_identities[https://en.wikipedia.org/wiki/Newton%27s_identities]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">power_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">elementary_symmetric_polynomial</span><span class="p">):</span>
        <span class="n">_update_elementary_symmetric_polynomial</span><span class="p">(</span><span class="n">power_sum</span><span class="p">,</span> <span class="n">elementary_symmetric_polynomial</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">power_sum</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">elementary_symmetric_polynomial</span><span class="p">):</span>
        <span class="n">_update_power_sum</span><span class="p">(</span><span class="n">power_sum</span><span class="p">,</span> <span class="n">elementary_symmetric_polynomial</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_update_elementary_symmetric_polynomial</span><span class="p">(</span><span class="n">power_sum</span><span class="p">,</span> <span class="n">elementary_symmetric_polynomial</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elementary_symmetric_polynomial</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">power_sum</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elementary_symmetric_polynomial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">elementary_symmetric_polynomial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">el</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">power_sum</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">elementary_symmetric_polynomial</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">el</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">elementary_symmetric_polynomial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_update_power_sum</span><span class="p">(</span><span class="n">ps_vec</span><span class="p">,</span> <span class="n">esp_vec</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ps_vec</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">esp_vec</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ps_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">temp_ps</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="n">sign</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">temp_ps</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">esp_vec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">ps_vec</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">sign</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">temp_ps</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">esp_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span>
        <span class="n">ps_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_ps</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">vietes</span><span class="p">(</span><span class="n">coefficients</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given the coefficients of a polynomial of a single variable,</span>
<span class="sd">    compute an elementary symmetric polynomial of the roots of the</span>
<span class="sd">    input polynomial by Viete&#39;s Formula:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \sum_{1\le i_1&lt;i_2&lt;...&lt;i_k \le n} x_{i_1}x_{i_2}...x_{i_k} = (-1)^k\frac{a_{n-k}}{a_n}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coefficients: list of float</span>
<span class="sd">        A list of coefficients of the input polynomial of arbitrary length (degree) `n`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of float:</span>
<span class="sd">        A list containing the expression of the roots of the input polynomial of length `n`</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    https://en.wikipedia.org/wiki/Vieta%27s_formulas</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">elementary_symmetric_polynomial</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">tail</span>
        <span class="n">elementary_symmetric_polynomial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">elementary_symmetric_polynomial</span>


<span class="nd">@give_repr</span>
<span class="k">class</span> <span class="nc">Isotope</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Isotope represents an elenent with an integer number of neutrons specified.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mass: float</span>
<span class="sd">        Measurable mass in Da</span>
<span class="sd">    abundance: float [0.0:1.0]</span>
<span class="sd">        The abundance of this isotope in nature. This number is between 0.0 and 1.0</span>
<span class="sd">    neutron_shift: int</span>
<span class="sd">        The number of neutrons different between this isotope and the &quot;normal&quot; form. May be 0</span>
<span class="sd">        if this represents that normal form.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">abundance</span><span class="p">,</span> <span class="n">neutron_shift</span><span class="p">,</span> <span class="n">neutrons</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span> <span class="o">=</span> <span class="n">abundance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutrons</span> <span class="o">=</span> <span class="n">neutrons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutron_shift</span> <span class="o">=</span> <span class="n">neutron_shift</span>


<span class="nd">@give_repr</span>
<span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">isotopes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="n">isotopes</span> <span class="ow">or</span> <span class="n">_isotopes_of</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">average_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">isotope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mass</span> <span class="o">+=</span> <span class="n">isotope</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">isotope</span><span class="o">.</span><span class="n">abundance</span>
        <span class="k">return</span> <span class="n">mass</span>

    <span class="k">def</span> <span class="nf">monoisotopic_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mass</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">max_neutron_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">neutron_shift</span>

    <span class="k">def</span> <span class="nf">min_neutron_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">neutron_shift</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">symbol</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_fixed_isotope_element</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">neutrons</span><span class="p">):</span>
    <span class="n">isotope</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">isotopes</span><span class="p">[</span><span class="n">neutrons</span> <span class="o">-</span> <span class="n">element</span><span class="o">.</span><span class="n">isotopes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">neutrons</span><span class="p">]</span>
    <span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">neutrons</span><span class="p">),</span> <span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Isotope</span><span class="p">(</span><span class="n">isotope</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">abundance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">neutron_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">neutrons</span><span class="o">=</span><span class="n">neutrons</span><span class="p">)),</span>
        <span class="p">]))</span>
    <span class="k">return</span> <span class="n">el</span>


<span class="k">def</span> <span class="nf">_isotopes_of</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mass_freqs</span> <span class="ow">in</span> <span class="n">nist_mass</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">mass_freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mass_freqs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">mono_neutrons</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(((</span><span class="n">k</span> <span class="o">-</span> <span class="n">mono_neutrons</span><span class="p">,</span> <span class="n">Isotope</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">neutron_shift</span><span class="o">=</span><span class="n">k</span> <span class="o">-</span> <span class="n">mono_neutrons</span><span class="p">,</span> <span class="n">neutrons</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">freqs</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">freqs</span>


<span class="n">periodic_table</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">Element</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nist_mass</span><span class="p">}</span>
<span class="c1"># periodic_table = {k: e for k, e in periodic_table.items() if e.max_neutron_shift() != 0 and e.min_neutron_shift() &gt;= 0}</span>
<span class="n">periodic_table</span><span class="p">[</span><span class="s2">&quot;H+&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;H+&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IsotopicConstants</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>

    <span class="nd">@order</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_coefficients</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">with_mass</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">max_isotope_number</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">max_neutron_shift</span><span class="p">()</span>
        <span class="n">accumulator</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">isotope</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">element</span><span class="p">)):</span>
            <span class="n">current_order</span> <span class="o">=</span> <span class="n">max_isotope_number</span> <span class="o">-</span> <span class="n">isotope</span><span class="o">.</span><span class="n">neutron_shift</span>
            <span class="k">if</span> <span class="n">with_mass</span><span class="p">:</span>
                <span class="n">coef</span> <span class="o">=</span> <span class="n">isotope</span><span class="o">.</span><span class="n">mass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coef</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="k">if</span> <span class="n">current_order</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">accumulator</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accumulator</span><span class="p">),</span> <span class="n">current_order</span><span class="p">):</span>
                    <span class="n">accumulator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
                <span class="n">accumulator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isotope</span><span class="o">.</span><span class="n">abundance</span> <span class="o">*</span> <span class="n">coef</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">current_order</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">accumulator</span><span class="p">):</span>
                <span class="n">accumulator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isotope</span><span class="o">.</span><span class="n">abundance</span> <span class="o">*</span> <span class="n">coef</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The list of neutron shifts is not ordered.&quot;</span><span class="p">)</span>

        <span class="n">elementary_symmetric_polynomial</span> <span class="o">=</span> <span class="n">vietes</span><span class="p">(</span><span class="n">accumulator</span><span class="p">)</span>
        <span class="n">power_sum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newton</span><span class="p">(</span><span class="n">power_sum</span><span class="p">,</span> <span class="n">elementary_symmetric_polynomial</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">accumulator</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PolynomialParameters</span><span class="p">(</span><span class="n">elementary_symmetric_polynomial</span><span class="p">,</span> <span class="n">power_sum</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">periodic_table</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">periodic_table</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">symbol_parsed</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="n">_get_isotope</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isotope</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">make_fixed_isotope_element</span><span class="p">(</span><span class="n">periodic_table</span><span class="p">[</span><span class="n">symbol_parsed</span><span class="p">],</span> <span class="n">isotope</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">max_neutron_shift</span><span class="p">()</span>
        <span class="n">element_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">mass_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">PhiConstants</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">element_parameters</span><span class="p">,</span> <span class="n">mass_parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">phi_constants</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&lt;</span> <span class="n">phi_constants</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phi_constants</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">phi_constants</span><span class="o">.</span><span class="n">element_coefficients</span><span class="o">.</span><span class="n">elementary_symmetric_polynomial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
                <span class="n">phi_constants</span><span class="o">.</span><span class="n">mass_coefficients</span><span class="o">.</span><span class="n">elementary_symmetric_polynomial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

            <span class="n">phi_constants</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_constants</span><span class="o">.</span><span class="n">element_coefficients</span><span class="o">.</span><span class="n">elementary_symmetric_polynomial</span><span class="p">)</span>
            <span class="n">newton</span><span class="p">(</span><span class="o">*</span><span class="n">phi_constants</span><span class="o">.</span><span class="n">element_coefficients</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">phi_constants</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
            <span class="n">newton</span><span class="p">(</span><span class="o">*</span><span class="n">phi_constants</span><span class="o">.</span><span class="n">mass_coefficients</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">phi_constants</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nth_element_power_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">constants</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">element_coefficients</span><span class="o">.</span><span class="n">power_sum</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">nth_modified_element_power_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">constants</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">mass_coefficients</span><span class="o">.</span><span class="n">power_sum</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>


<div class="viewcode-block" id="max_variants"><a class="viewcode-back" href="../../index.html#brainpy.max_variants">[docs]</a><span class="k">def</span> <span class="nf">max_variants</span><span class="p">(</span><span class="n">composition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the maximum number of isotopic variants that could be produced by a</span>
<span class="sd">    composition.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    composition : Mapping</span>
<span class="sd">        Any Mapping type where keys are element symbols and values are integers</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        max_n_variants : int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_n_variants</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">composition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s2">&quot;H+&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_n_variants</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">periodic_table</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">max_neutron_shift</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">max_n_variants</span></div>


<div class="viewcode-block" id="Peak"><a class="viewcode-back" href="../../index.html#brainpy.Peak">[docs]</a><span class="nd">@give_repr</span>
<span class="k">class</span> <span class="nc">Peak</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represent a single theoretical peak centroid.</span>

<span class="sd">    Peaks are comparable, hashable, and can be copied by calling</span>
<span class="sd">    :meth:`clone`</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    charge : int</span>
<span class="sd">        The charge state of the peak</span>
<span class="sd">    intensity : float</span>
<span class="sd">        The height of the peak. Peaks created as part of a</span>
<span class="sd">        theoretical isotopic cluster will be have an intensity</span>
<span class="sd">        between 0 and 1.</span>
<span class="sd">    mz : float</span>
<span class="sd">        The mass-to-charge ratio of the peak</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">charge</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">=</span> <span class="n">mz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">equal</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">mz</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">,</span>
            <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">intensity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">equal</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span></div>


<span class="nd">@give_repr</span>
<span class="k">class</span> <span class="nc">IsotopicDistribution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a theoretical isotopic distribution for a given composition</span>
<span class="sd">    out to a given number of peaks.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    average_mass : float</span>
<span class="sd">        The average (weighted) mass of the resulting isotopic cluster</span>
<span class="sd">    composition : dict</span>
<span class="sd">        The composition to create the isotopic cluster for</span>
<span class="sd">    order : int</span>
<span class="sd">        The number of peaks to produce and the number of terms in the</span>
<span class="sd">        generating polynomial expression.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition</span><span class="p">,</span> <span class="n">order</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="n">composition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isotopic_constants</span> <span class="o">=</span> <span class="n">IsotopicConstants</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average_mass</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monoisotopic_peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_monoisotopic_peak</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>

    <span class="nd">@order</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">max_variant_count</span> <span class="o">=</span> <span class="n">max_variants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="n">max_variant_count</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_variant_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_isotopic_constants</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_isotopic_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isotopic_constants</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isotopic_constants</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>

    <span class="k">def</span> <span class="nf">_create_monoisotopic_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">calculate_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s2">&quot;H+&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># intensity += log(periodic_table[element].isotopes[0].abundance)</span>
            <span class="n">intensity</span> <span class="o">+=</span> <span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isotopic_constants</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">isotopes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abundance</span><span class="p">)</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Peak</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_phi_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s2">&quot;H+&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">phi</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isotopic_constants</span><span class="o">.</span><span class="n">nth_element_power_sum</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span>
        <span class="k">return</span> <span class="n">phi</span>

    <span class="k">def</span> <span class="nf">_modified_phi_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s2">&quot;H+&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Count is one lower for this symbol because an isotope is present</span>
            <span class="c1"># accounted for in the call to `nth_modified_element_power_sum` at</span>
            <span class="c1"># the end?</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">count</span> <span class="k">if</span> <span class="n">element</span> <span class="o">!=</span> <span class="n">symbol</span> <span class="k">else</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">phi</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isotopic_constants</span><span class="o">.</span><span class="n">nth_element_power_sum</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">*</span> <span class="n">coef</span>

        <span class="n">phi</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isotopic_constants</span><span class="o">.</span><span class="n">nth_modified_element_power_sum</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phi</span>

    <span class="k">def</span> <span class="nf">phi_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">power_sum</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">power_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phi_value</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">power_sum</span>

    <span class="k">def</span> <span class="nf">modified_phi_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="n">power_sum</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">power_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modified_phi_value</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">power_sum</span>

    <span class="k">def</span> <span class="nf">probability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phi_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_values</span><span class="p">()</span>
        <span class="n">max_variant_count</span> <span class="o">=</span> <span class="n">max_variants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
        <span class="n">probability_vector</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newton</span><span class="p">(</span><span class="n">phi_values</span><span class="p">,</span> <span class="n">probability_vector</span><span class="p">,</span> <span class="n">max_variant_count</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">probability_vector</span><span class="p">)):</span>
            <span class="c1"># The sign of each term in the probability vector (populated by</span>
            <span class="c1"># Newton&#39;s Identities by solving for the Elementary Symmetric Polynomial</span>
            <span class="c1"># given the Power Sums) alternates in the same order as `sign`.</span>
            <span class="c1"># This ensures that the probability vector is strictly positive.</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c1"># q(j) = q(0)  * e(j) * (-1)^j</span>
            <span class="c1"># intensity of the jth peak is |probability[j]| * the intensity of monoisotopic peak</span>
            <span class="n">probability_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monoisotopic_peak</span><span class="o">.</span><span class="n">intensity</span> <span class="o">*</span> <span class="n">sign</span>

        <span class="k">return</span> <span class="n">probability_vector</span>

    <span class="k">def</span> <span class="nf">center_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability_vector</span><span class="p">):</span>
        <span class="n">mass_vector</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_variant_count</span> <span class="o">=</span> <span class="n">max_variants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>

        <span class="n">ele_sym_poly_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s2">&quot;H+&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">power_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified_phi_values</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">ele_sym_poly</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">newton</span><span class="p">(</span><span class="n">power_sum</span><span class="p">,</span> <span class="n">ele_sym_poly</span><span class="p">,</span> <span class="n">max_variant_count</span><span class="p">)</span>
            <span class="n">ele_sym_poly_map</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">ele_sym_poly</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">center</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">ele_sym_poly</span> <span class="ow">in</span> <span class="n">ele_sym_poly_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">center</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">*</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">ele_sym_poly</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>\
                 <span class="bp">self</span><span class="o">.</span><span class="n">monoisotopic_peak</span><span class="o">.</span><span class="n">intensity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isotopic_constants</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">monoisotopic_mass</span><span class="p">()</span>
                 <span class="c1"># self.monoisotopic_peak.intensity * periodic_table[element].monoisotopic_mass()</span>
            <span class="n">mass_vector</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">center</span> <span class="o">/</span> <span class="n">probability_vector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">probability_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mass_vector</span>

    <span class="k">def</span> <span class="nf">aggregated_isotopic_variants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge_carrier</span><span class="o">=</span><span class="n">PROTON</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the m/z (or neutral mass when `charge` == 0) for each</span>
<span class="sd">        aggregated isotopic peak and their intensity relative to</span>
<span class="sd">        the monoisotopic peak.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        charge: int</span>
<span class="sd">            The charge state of the resulting theoretical isotopic cluster</span>
<span class="sd">        charge_carrier: float</span>
<span class="sd">            The mass added for each degree of charge</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        theoretical_isotopic_distribution: list</span>
<span class="sd">            A list of :class:`Peak` objects whose intensities are proportional to</span>
<span class="sd">            each other to reflect relative peak heights.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">probability_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probability</span><span class="p">()</span>
        <span class="n">center_mass_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_mass</span><span class="p">(</span><span class="n">probability_vector</span><span class="p">)</span>

        <span class="n">peak_set</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">average_mass</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">probability_vector</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">charge</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">adjusted_mz</span> <span class="o">=</span> <span class="n">mass_charge_ratio</span><span class="p">(</span><span class="n">center_mass_vector</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">charge</span><span class="p">,</span> <span class="n">charge_carrier</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">adjusted_mz</span> <span class="o">=</span> <span class="n">center_mass_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">adjusted_mz</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">Peak</span><span class="p">(</span><span class="n">adjusted_mz</span><span class="p">,</span> <span class="n">probability_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span><span class="p">,</span> <span class="n">charge</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">peak</span><span class="o">.</span><span class="n">intensity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">peak_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>
            <span class="n">average_mass</span> <span class="o">+=</span> <span class="n">adjusted_mz</span> <span class="o">*</span> <span class="n">probability_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">average_mass</span> <span class="o">/=</span> <span class="n">total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average_mass</span> <span class="o">=</span> <span class="n">average_mass</span>
        <span class="n">peak_set</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mz_getter</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">peak_set</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">isotopic_variants</span><span class="p">(</span><span class="n">composition</span><span class="p">,</span> <span class="n">npeaks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge_carrier</span><span class="o">=</span><span class="n">PROTON</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute a peak list representing the theoretical isotopic cluster for `composition`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    composition : Mapping</span>
<span class="sd">        Any Mapping type where keys are element symbols and values are integers</span>
<span class="sd">    npeaks: int</span>
<span class="sd">        The number of peaks to include in the isotopic cluster, starting from the monoisotopic peak.</span>
<span class="sd">        If given a number below 1 or above the maximum number of isotopic variants, the maximum will</span>
<span class="sd">        be used. If `None`, a &quot;reasonable&quot; value is chosen by `int(sqrt(max_variants(composition)))`.</span>
<span class="sd">    charge: int</span>
<span class="sd">        The charge state of the isotopic cluster to produce. Defaults to 0, theoretical neutral mass.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of Peaks</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :class:`IsotopicDistribution`</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">npeaks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_n_variants</span> <span class="o">=</span> <span class="n">max_variants</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
        <span class="n">npeaks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">max_n_variants</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">npeaks</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npeaks</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Monoisotopic Peak is not included</span>
        <span class="n">npeaks</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">IsotopicDistribution</span><span class="p">(</span><span class="n">composition</span><span class="p">,</span> <span class="n">npeaks</span><span class="p">)</span><span class="o">.</span><span class="n">aggregated_isotopic_variants</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span> <span class="n">charge_carrier</span><span class="o">=</span><span class="n">charge_carrier</span><span class="p">)</span>


<span class="k">try</span><span class="p">:</span>
    <span class="n">_has_c</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_IsotopicDistribution</span> <span class="o">=</span> <span class="n">IsotopicDistribution</span>
    <span class="kn">from</span> <span class="nn">._speedup</span> <span class="k">import</span> <span class="n">IsotopicDistribution</span>
    <span class="kn">from</span> <span class="nn">._c.isotopic_distribution</span> <span class="k">import</span> <span class="n">pyisotopic_variants</span> <span class="k">as</span> <span class="n">isotopic_variants</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_has_c</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">brainpy</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Joshua Klein and Han Hu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>